# Gitlabä¸Šä¼ é¡¹ç›®å’ŒJenkinséƒ¨ç½²é•œåƒ

> ç›®å‰éœ€è¦å¼€å‘è‡ªå·±æ‰‹åŠ¨å¤„ç†





## ä¸€ã€gitlabä¸Šä¼ é¡¹ç›®

> ç›®å‰åªèƒ½ä¸ªäººç”µè„‘è®¿é—®è¿™ä¸ªåœ°å€ï¼Œå…¬å¸ç”µè„‘æ— æ³•è®¿é—®ï¼Œä¼šè¢«block
>
> ç›®å‰å…ˆç”¨amdinè´¦å·ç™»å½•ï¼Œåç»­ä¼šåˆ›å»ºä¸ªäººè´¦å·çš„

```shell
ç™»å½•gitlab åœ°å€ä¸ºï¼š http://gitlab.yotta.ink/
  
# è´¦å·å¯†ç ç™»å½•
è´¦å·ï¼šroot
å¯†ç ï¼šrqMtBm/2IT0gjGWBWJhPgCU5negmYrei8dPSVuvyM+Q=

ç‚¹å‡» å³ä¸Šè§’ new project
```
![img-1684734850989](./img/1684734850989.jpg)

```shell
è¿›å…¥ä¸‹ä¸€ä¸ªé¡µé¢ç‚¹å‡»ç¬¬ä¸€ä¸ª
åˆ›å»ºä¸€ä¸ªç©ºçš„é¡¹ç›®
```
![img-1684734989246](./img/1684734989246.jpg)



```
è¾“å…¥é¡¹ç›®åç§°åŠä¿¡æ¯  ç„¶åé€‰æ‹©public level
è®°å¾— ä¸è¦ å‹¾é€‰ Initialize repository   with a README

```

![img-1684918646847](./img/1684918646847.jpg)

ç‚¹å‡»createprojectå®Œæˆåˆ›å»º
ä¸‹ä¸€æ­¥å°†æ–°å»ºçš„é¡¹ç›®cloneåˆ°æœ¬åœ°



**â­ï¸æ³¨æ„ğŸ“¢ï¼šcloneåœ°å€å¤åˆ¶ä¸‹æ¥é»˜è®¤æ²¡æœ‰ç«¯å£çš„ï¼Œéœ€è¦æ‰‹åŠ¨æ·»åŠ ç«¯å£8001 ä»¥swr-reinsuranceä¸ºä¾‹ï¼š**

**é»˜è®¤ï¼š**

```shell
http://52.74.16.184/root/swr-reinsurance.git
```
**éœ€è¦æ”¹æˆä¸‹é¢çš„ï¼š**

```shell
http://52.74.16.184:8001/root/swr-reinsurance.git
```


### ä¸­é—´ä»¶ä¿¡æ¯

> â­ï¸éº»çƒ¦æŠŠ**é…ç½®å†™æ­»åˆ°yamlæ–‡ä»¶ä¸­**
>
> ğŸ“¢é™¤ä¿®æ”¹åœ°å€ç«¯å£å¤–**ï¼Œmysqlè¿æ¥é…ç½®ä¸­çš„useSSLå’ŒrequireSSLä¹Ÿéƒ½è¦æ”¹æˆfalse  useSSL=false&requireSSL=false**
>
> â­ï¸éº»çƒ¦æŠŠlogbackçš„æ—¥å¿—ä¿å­˜å¤©æ•°æ”¹æˆ**1å¤© 1å¤© 1å¤© ** æ—¥å¿—åªä¿ç•™ä¸€å¤©
```shell
å°†ä¸‹é¢é…ç½®å¤åˆ¶åˆ°logback-spring.xmlä¸­ configuration çš„èŠ‚ç‚¹ä¸‹

    <!-- å®šä¹‰æ—¥å¿—çš„æ ¹ç›®å½• -->
    <property name="LOG_HOME" value="/opt/logs"/>
    <property name="LOG_FILE" value="æ”¹æˆè‡ªå·±çš„é¡¹ç›®åç§°"/>
    <!-- æŒ‰ç…§æ¯å¤©ç”Ÿæˆæ—¥å¿—æ–‡ä»¶ -->
    <!--å®˜ç½‘åœ°å€ï¼š https://logback.qos.ch/manual/appenders.html#TimeBasedRollingPolicy-->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>${LOG_HOME}/${LOG_FILE}.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <!-- daily rollover -->
            <fileNamePattern>${LOG_HOME}/${LOG_FILE}.%d{yyyy-MM-dd}.log</fileNamePattern>

            <!-- keep 30 days' worth of history capped at 3GB total size -->
            <maxHistory>1</maxHistory>
<!--            <totalSizeCap>3GB</totalSizeCap>-->
            <cleanHistoryOnStart>true</cleanHistoryOnStart>
        </rollingPolicy>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %C:%M:%L [%thread] %-5level %msg%n</pattern>
        </encoder>
    </appender>
    <!--rootèŠ‚ç‚¹ä¸‹è¦åŠ ä¸Š<appender-ref ref="FILE" />-->
    <root level="INFO">
        <appender-ref ref="STDOUT"/>
        <appender-ref ref="FILE" />
    </root>
```

|       æœåŠ¡        |    IP     | ç«¯å£ |   è´¦å·   |        å¯†ç          |
| :---------------: | :-------: | :--: | :------: | :-----------------: |
|     **mysql**     | 10.0.0.38 | 3307 |   root   | 35503059a8314f499a  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_aml   | X4!tCxlJC$EP7WH6  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_bcp   | Dk1WhH~zXzmtptx3  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_claim   | O2m2O@vdFy~1~)kb  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_core   | Kjmind^C5@(+~@F@  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_customer_service   | Ra7ggu3zNvZ_9u_)  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_dms   | BbDLVto0ne7oQynb  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_eb_1   | +ip)V+u1YWSUPf#n  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_eb_indigo_server   | bN+_YktKyve6X#eK  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_eb_partner   | WWZ6SgkAph9ZTJ~y  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_eb_smartgateway   | !V1P*AzH8M~(f3+6  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_eb_vas   | 6i4BsFZJyGzkD+uL  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_prod_config   | w3vV4ruQeumEZZeF  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_product_config   | ZY0!Y%duCP~P0D~P  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_reinsurance   | PGk23tt4sth^QCIc  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_reserve   | sxb1Bdb3v+P#LwVf  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_sso   | J&wxx&~sKLwEF)5a  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_traceability   | KKL)X(a0jLpZJCyw  |
|     **mysql**     | 10.0.0.38 | 3307 |   test_yotta_workflow   | s7UBw@BizPfW7DQB  |
|     **mysql**     | 10.0.0.38 | 3307 |   insurance   | nWFJU^s2SsFAuqiZ  |
|     **mysql**     | 10.0.0.38 | 3307 |   assistant   | 5^Bmpc69U6w8n$ED  |
|     **mysql**     | 10.0.0.38 | 3307 |   eb-traceability   | hv)2o6+ocWAj%eKW  |
|     **redis**     | 10.0.0.38 | 6379 | æ²¡æœ‰è´¦å· | 0ca5db3e15b84acf941 |
|   **RocketMQ**    | 10.0.0.38 | 9876 | æ²¡æœ‰è´¦å· |      æ²¡æœ‰å¯†ç        |
|     **Nacos**     | 10.0.0.38 | 8848 | æ²¡æœ‰è´¦å· |      æ²¡æœ‰å¯†ç        |
| **Xxl-job-amdin** | http://xxl-job-admin.test-xxl-job.svc.cluster.local/xxl-job-admin/ | æ—  | æ²¡æœ‰è´¦å· |      æ²¡æœ‰å¯†ç        |
| **MongoDB** | **10.0.0.38** | **27017** | **root** | **123456** |





### DockerFileé…ç½®

```
åœ¨é¡¹ç›®æ ¹ç›®å½•æ”¾å…¥æ–°å¢dockeræ–‡ä»¶å¤¹ï¼Œ
åç«¯é¡¹ç›®ï¼šcopyé¡¹ç›®swr-reinsuranceæ ¹ç›®å½•ä¸‹çš„dockerfileæ–‡ä»¶å³å¯ï¼Œå†…å®¹ä¸éœ€è¦æ›´æ”¹ï¼Œå®Œå…¨copyå°±å¯ä»¥
å‰ç«¯é¡¹ç›®ï¼šcopyé¡¹ç›®yotta-core-uiæ ¹ç›®å½•ä¸‹çš„dockerfileæ–‡ä»¶å³å¯ï¼Œå†…å®¹ä¸éœ€è¦æ›´æ”¹ï¼Œå®Œå…¨copyå°±å¯ä»¥
ç„¶åä¸Šä¼ å³å¯
```



**ä¿®æ”¹é»˜è®¤åˆ†æ”¯**

```shell
# æŠŠmainåˆ†æ”¯æ”¹ä¸ºmasteråˆ†æ”¯ï¼ˆé»˜è®¤æ˜¯mainåˆ†æ”¯ï¼‰
1.æ–°å»ºmasteråˆ†æ”¯ï¼Œpushåˆ°gitlab
2ï¼Œåˆ é™¤mainåˆ†æ”¯ï¼ŒæŠŠmasteråˆ†æ”¯è®¾ç½®ä¸ºé»˜è®¤åˆ†æ”¯ æŒ‰ç…§ä¸‹é¢æˆªå›¾æ“ä½œ
```
![img-1684735957774](./img/1684735957774.jpg)
![img-1684736046048](./img/1684736046048.jpg)
![img-1684736135787](./img/1684736135787.jpg)
![img-1684736216795](./img/1684736216795.jpg)

```shell
è¿”å›åˆ°Branchesç›®å½•åˆ·æ–°é¡µé¢ï¼Œåˆ é™¤mainåˆ†æ”¯ï¼Œåœ¨å¼¹æ¡†è¾“å…¥æ¡†è¾“å…¥mainæ‰å¯åˆ é™¤
å¦åˆ™åˆ é™¤æŒ‰é’®æ˜¯ç°è‰²ä¸å¯ç‚¹å‡»
```





## äºŒã€jenkinsé…ç½®

> ***éœ€è¦æ‰‹åŠ¨å»ºç«‹pipelineæ‰“åŒ…æˆé•œåƒæ¨åˆ°ç§æœé•œåƒä»“åº“é‡Œé¢å»***

> ç™»å½•jenkins åœ°å€ä¸ºï¼šhttp://jenkins.yotta.ink/
>
> **ç”¨æˆ·å**ï¼šadmin
> **å¯†ç **ï¼šJackGao5210

**æŒ‰ä¸‹é¢æˆªå›¾æ“ä½œï¼š**



### 1ã€åç«¯æ„å»ºpipeline

![img-1684736573660](./img/1684736573660.jpg)
![img-1684736736988](./img/1684736736988.jpg)



**åç«¯ å‚è€ƒadmin-ssoè¿™ä¸ªä»»åŠ¡é‡Œçš„é…ç½®è®¾ç½®è‡ªå·±çš„ä»»åŠ¡**

![img-1684736915997](./img/1684736915997.jpg)
![img-1684736976432](./img/1684736976432.jpg)
![img-1684737104119](./img/1684737104119.jpg)
![img-1684737181716](./img/1684737181716.jpg)
![img-1684737227633](./img/1684737227633.jpg)
![img-1684737305045](./img/1684737305045.jpg)
![img-1684742303682](./img/1684742303682.jpg)

**æ„å»ºè§¦å‘å™¨ï¼ˆgitlabæäº¤ä»£ç åjekinsè‡ªåŠ¨æ„å»ºï¼‰** 
>è¿™ä¸€æ­¥å¯¹åº”ä¸‹é¢çš„gitlabçš„webhooksçš„é…ç½®
![img-1685692105178](./img/1685692105178.jpg)
![img-1685692153647](./img/1685692153647.jpg)
![img-1685690261002](./img/1685690261002.jpg)

ğŸ“¢ğŸ“¢â­ï¸â­ï¸ **æ³¨ï¼šDockerfile Pathä¸­çš„é…ç½®è·¯å¾„è¦ä¸Dockerfileæ‰€åœ¨é¡¹ç›®è·¯å¾„ä¸€è‡´**

> ç„¶ååº”ç”¨-ä¿å­˜ï¼Œè¿”å›ä»»åŠ¡-->ç«‹å³æ„å»º--è¿›å…¥æ„å»ºçš„ä»»åŠ¡--ç‚¹å‡»æ§åˆ¶å°è¾“å‡ºå¯ä»¥æŸ¥çœ‹æ„å»ºæ—¥å¿—
> æ—¥å¿—æœ€åæ˜¾ç¤ºFinished: SUCCESS è¡¨ç¤ºæ„å»ºæˆåŠŸ

![img-1684742431456](./img/1684742431456.jpg)

ğŸ“¢ğŸ“¢â­ï¸â­ï¸ **ä¸ºäº†å®ç°æäº¤ä»£ç åjekinsè‡ªåŠ¨æ„å»ºè¿˜éœ€è¦é…ç½®ä¸€ä¸‹gitlabçš„webhooks** 
> ç™»å½•gitlabï¼Œè¿›å…¥è¦é…ç½®çš„é¡¹ç›®-->--å·¦ä¾§èœå•æ settings-->webhooks
>æŒ‰ç…§ä¸‹é¢æˆªå›¾è¿›è¡Œé…ç½®

![img-1685690805372](./img/1685690805372.jpg)
![img-1685690895445](./img/1685690895445.jpg)
![img-1685691064845](./img/1685691064845.jpg)
![img-1685691118268](./img/1685691118268.jpg)
> æœ€åå»jekinsé‡Œçœ‹ä¸‹æ˜¯å¦åœ¨æ„å»º


### 2ã€å‰ç«¯æ„å»ºpipeline

> **éœ€è¦ç¡®è®¤è¯¥é¡¹ç›®é€‚ç”¨äºå“ªä¸ªç‰ˆæœ¬çš„nodeJs  å› ä¸ºæœ‰çš„é¡¹ç›®åªèƒ½ç”¨ç‰¹å®šç‰ˆæœ¬çš„nodejsæ‰“åŒ…** 
>
> â­ï¸â­ï¸**ç¡®è®¤å‰ç«¯çš„nodeç‰ˆæœ¬ã€ç¡®è®¤å‰ç«¯çš„nodeç‰ˆæœ¬ã€ç¡®è®¤å‰ç«¯çš„nodeç‰ˆæœ¬**
>
> å‚ç…§admin-web å·¥ç¨‹



**2.1 åœ¨jenkinsä¸Šæ–°å»ºä¸€ä¸ªè‡ªç”±é£æ ¼çš„è½¯ä»¶é¡¹ç›®**

![image-20230525103532440](./img/image-20230525103532440.png)



**2.1.1 JDKé…ç½®**

> é€‰æ‹©é»˜è®¤å³å¯

![image-20230525103641640](./img/image-20230525103641640.png)



**2.1.2 Gité…ç½®**

![image-20230525103825012](./img/image-20230525103825012.png)



**.1.3 æ„å»ºç¯å¢ƒé…ç½®**

![image-20230525104012723](./img/image-20230525104012723.png)

*2.1.4 å¢åŠ æ„å»ºæ­¥éª¤**

å¢åŠ  æ‰§è¡Œshell

> ä¸ºäº†node æ‰“åŒ…

![image-20230525104153735](./img/image-20230525104153735.png)

æ–°å¢ä¸‹é¢çš„å‘½ä»¤

```shell
npm uninstall
npm i
npm run build

```

```shell
docker login 52.74.16.184:8081 -u admin -p Harbor12345
```

![image-20230525104312043](./img/image-20230525104312043.png)



æ–°å¢æ„å»ºé…ç½®

> ä¸ºäº†æ‰“å‰ç«¯é•œåƒ



![image-20230525104353198](./img/image-20230525104353198.png)

Docker Build and Publish é…ç½®

![image-20230525104649323](./img/image-20230525104649323.png)

![image-20230525104823676](./img/image-20230525104823676.png)

ç„¶åç‚¹å‡»ä¿å­˜



**å¢åŠ æ‰§è¡Œæ­¥éª¤--æ‰§è¡Œshell**

> *ä¸ºäº†èŠ‚çº¦ç¡¬ç›˜ç©ºé—´*

![image-20230601164617541](./img/image-20230601164617541.png)

å¢åŠ ä»¥ä¸‹è„šæœ¬

> åˆ‡è®°è¦æ¢æˆè‡ªå·±çš„é•œåƒåç§°

```shell
docker rmi 52.74.16.184:8081/library/æ¢æˆè‡ªå·±çš„é•œåƒåç§°:$BUILD_NUMBER
docker rmi 52.74.16.184:8081/library/æ¢æˆè‡ªå·±çš„é•œåƒåç§°:latest
```

![image-20230601164827077](./img/image-20230601164827077.png)



**2.1.5 éªŒè¯**

> ç‚¹å‡»ç«‹å³æ„å»ºï¼Œå¦‚æœæ‰“åŒ…æ­£å¸¸ï¼Œä¸”é•œåƒå·²ç»ä¸Šä¼ åˆ°ç§æœä»“åº“å°±ç®—é…ç½®æˆåŠŸ



![image-20230525105049294](./img/image-20230525105049294.png)
